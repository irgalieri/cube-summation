<html>
    <header>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>Ignacio R. Galieri</title>
    </header>
    <body>
        <nav class="navbar navbar-default">
          <div class="container-fluid">
            <div class="navbar-header">
              <a class="navbar-brand" href="#">
                Cube Summation by Ignacio R. Galieri
              </a>
            </div>
          </div>
        </nav>
        <div class="container bs-docs-container">
            <div class="row">
                <div>
                    <div class="panel panel-default">
                      <div class="panel-heading">
                        <h3 class="panel-title">Terminal</h3>
                      </div>
                      <div class="panel-body">
                        <div id="term"></div>
                      </div>
                    </div>
                </div>
                <div>
                    <div class="panel panel-default">
                      <div class="panel-heading">
                        <h3 class="panel-title">Bulk</h3>
                      </div>
                      <div class="panel-body">
                          <form>
                              <div class="form-group">
                                <label for="bulk-input" class="col-sm-1 control-label">Input:</label>
                                <div class="col-sm-5">
                                    <textarea id="bulk-input" class="form-control" rows="3" height="60px">
  2
  4 5
  UPDATE 2 2 2 4
  QUERY 1 1 1 3 3 3
  UPDATE 1 1 1 23
  QUERY 2 2 2 4 4 4
  QUERY 1 1 1 3 3 3
  2 4
  UPDATE 2 2 2 1
  QUERY 1 1 1 1 1 1
  QUERY 1 1 1 2 2 2
  QUERY 2 2 2 2 2 2
                                    </textarea>
                                </div>
                              </div>
                              <div class="form-group">
                                <label for="bulk-output" class="col-sm-1 control-label">Output:</label>
                                <div class="col-sm-5">
                                    <textarea id="bulk-output" class="form-control" rows="3" height="60px"></textarea>
                                </div>
                              </div>
                          </form>
                      </div>
                      <div class="panel-footer">
                          <button id="btn-submit" type="button" class="btn btn-success btn-block">Submit</button>
                      </div>
                    </div>
                </div>
            </div>
        </div>
        <link rel="stylesheet" href="/bootstrap/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="/bootstrap/dist/css/bootstrap-theme.min.css">
        <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
        <link rel="stylesheet" href="/jquery.terminal/css/jquery.terminal.css">
        <script src="/jquery/dist/jquery.min.js"></script>
        <script src="/bootstrap/dist/js/bootstrap.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script src="/jquery.terminal/js/jquery.terminal-min.js"></script>
        <script>
        jQuery(function($, undefined) {
            "use strict";
            var options ={
                transports: ['websocket'],
                'force new connection': true
            };
            var socket = io('ws://localhost:8080', options);
            socket.on('connect', function () {
                socket.on('bulk-reponse', function(response){
                    var output = '';
                    response = JSON.parse(response);
                    $.each(response, function (index, value) {
                        if (value !== '') {
                            output = output + value + '\r\n';
                        }
                    });
                    $('#bulk-output').val(output);
                });
                socket.on('begin', function(data) {
                    $('#btn-submit').click(function (event) {
                        event.preventDefault();
                        var input = $('#bulk-input').val().trim();
                        var lines = input.split(/\r\n|\r|\n/g);
                        var obj = {};
                        var sizeTest = 0;
                        var sizeOperation = -1;
                        var actualTest = -1;
                        var error = false;
                        $.each(lines, function (index, value) {
                            if (error) {
                                return;
                            }
                            value = value.trim();
                            if (value.match(/^\d$/)) {
                                sizeTest = value;
                                obj.testCases = [];
                            } else if (value.match(/^\d \d$/)) {
                                actualTest++;
                                value = value.split(' ');
                                var t = {
                                    matrixSize: value[0],
                                    operations: []
                                };
                                obj.testCases.push(t);
                                sizeOperation = value[1];
                            } else if (value.match(/^UPDATE \d+ \d+ \d+ \d+$/)) {
                                value = value.replace('UPDATE ', '');
                                value = value.split(' ');
                                var op = {
                                    method: 'UPDATE',
                                    params: value
                                }
                                obj.testCases[actualTest].operations.push(op);
                                if (sizeOperation < obj.testCases[actualTest].operations.length) {
                                    alert('Exceeds the number of operations');
                                    error = true;
                                }
                            } else if (value.match(/^QUERY \d+ \d+ \d+ \d+ \d+ \d+$/)) {
                                value = value.replace('QUERY ', '');
                                value = value.split(' ');
                                var op = {
                                    method: 'QUERY',
                                    params: value
                                }
                                obj.testCases[actualTest].operations.push(op);
                                if (sizeOperation < obj.testCases[actualTest].operations.length) {
                                    alert('Exceeds the number of operations');
                                    error = true;
                                }
                            } else {
                                alert('Invalid Input Line:'+ value);
                                error = true;
                            }
                        });
                        if (sizeTest != obj.testCases.length) {
                            alert('Exceeds the number of testcases');
                            error = true;
                        }
                        if (!error) {
                            socket.emit('bulk', JSON.stringify(obj));
                        }
                    });
                    $('#term').terminal(
                        function(command, term) {
                            if (command !== '') {
                                try {
                                    var result = window.eval(command);
                                    if (result !== undefined) {
                                        term.echo(new String(result));
                                    }
                                } catch(e) {
                                    term.error(new String(e));
                                }
                            } else {
                               term.echo('');
                            }
                        },
                        {
                            greetings: data,
                            name: 'cube-summation',
                            height: 400,
                            prompt: 'I.R.G. $> '
                        }
                    );
                });
            });
        });
        </script>
    </body>
</html>
